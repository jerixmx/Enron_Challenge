#!/usr/bin/env python

from sys import argv
import os
import glob

def main(argv):
    if argCheck(argv):
        stopwords = loadStopwords()
        terms = defSearchTerms(argv,stopwords)

        print(terms)
        AND_operator = ANDCheck(argv)
        search_dir = getDir(argv)
        index_path = os.path.join(search_dir,'index.csv')
        indexExists = os.path.exists(index_path)
        if indexExists:
            print("Index found")
            if checkIndexFresh(search_dir,index_path):
                print("Fresh")
            else:
                print("Reindex")
        else:
            print("No index")
    else:
        return 1
    return 0

def loadStopwords():
    stopwords_file = open("./nltk-stopwords", "r")
    stopwords = stopwords_file.read().splitlines()
    stopwords_file.close()
    return stopwords

def defSearchTerms(argv, stopwords):
    i=1
    arg_length = len(argv)
    terms = set()
    for i in range(1,arg_length):
        if argv[i] not in ["-a", "-d", "-h", "--help"]:
            if argv[i-1] != "-d":
                if argv[i] not in stopwords:
                    terms.add(argv[i])
    return terms


def argCheck(argv):
    # Show syntax for incomplete arguments or help invoked.
    if len(argv) < 3 or ("--help" or "-h") in argv:
        print("Args < 3: " + str(len(argv)))
        syntax_help()
        return False    
    # Show syntax for -d not in arguments or no following
    elif not("-d" in argv) or argv[len(argv)-1] == "-d":
        print("Specify search directory")
        syntax_help()
        return False
    elif not(dirExists(argv)):
        print("Search directory does not exist")
        return False
    return True

def getDir(argv):
    i=1
    arg_length = len(argv)
    for i in range (arg_length-1):
        if argv[i] == "-d":
            search_dir = argv[i+1]
    return search_dir

def dirExists(argv):
    search_dir = getDir(argv)
    return os.path.exists(search_dir)

def ANDCheck(argv):
    # #Check whether -a
    # if ("-a" in argv):
    #     AND_operator = True
    # else:
    #     AND_operator = False
    return ("-a" in argv)

def syntax_help():
    print("Syntax: python sfor <term1> <term2> ... <termn> -d <path/to/search> [-a]")
    print("-a : (optional) Only return results matching All terms")


# def findIndex(search_dir):
#     for f_name in os.listdir(search_dir):
#         if f_name == 'index.csv':
#             return True
#     return False

def checkIndexFresh(search_dir,index_path):

    index_time = os.path.getmtime(index_path)
    for subdir, dirs, files in os.walk(search_dir):
        for filename in files:
            if "index.csv" not in filename:
                filepath = os.path.join(subdir,filename)
                if os.path.getmtime(filepath) > index_time:
                    return False #Index not fresh if modified time of files > modified time of index
    return True

main(argv)
